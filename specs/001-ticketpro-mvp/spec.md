# Feature Specification: TicketPro オンラインチケット販売システム MVP

**Feature Branch**: `001-ticketpro-mvp`  
**Created**: 2026-01-11  
**Status**: Draft  
**Input**: オンラインチケット販売システム要件定義.md, 単語集_オンラインチケット販売.md

## User Scenarios & Testing *(mandatory)*

### User Story 1 - イベント・会場・座席マスタ管理 (Priority: P1)

主催者がイベントを販売する前に、会場情報と座席表を登録し、イベントの基本情報とチケット種別を設定できる。

**Why this priority**: すべての機能の基盤となるマスタデータ。これがないと何も始まらない。

**Independent Test**: 主催者が管理画面にログインし、会場を登録（名称、住所、収容人数）→ 座席表を作成（ブロック、列、番号、座席種別）→ イベントを登録（名称、説明、開催日時、会場選択）→ チケット種別を設定（座席指定/自由席、価格、販売枚数）→ イベントを公開設定。これだけで独立したマスタ管理システムとして価値を提供。

**Acceptance Scenarios**:

1. **Given** 主催者が管理画面にログイン済み, **When** 会場を登録（名称、住所、収容人数）, **Then** 会場マスタに保存され、会場一覧に表示される
2. **Given** 会場が登録済み, **When** 座席表を作成（ブロック、列、番号、座席種別S/A/B）, **Then** 座席マスタに保存され、座席図が表示される
3. **Given** 会場と座席が登録済み, **When** イベント基本情報を登録（名称、説明、カテゴリ、開催日時、会場選択、主催者情報）, **Then** イベントが保存され、イベント一覧に表示される
4. **Given** イベントが登録済み, **When** チケット種別を設定（座席指定チケット、価格3000円、販売枚数100枚）, **Then** チケット種別が保存され、イベント詳細画面に表示される
5. **Given** イベントが非公開, **When** 公開設定に変更, **Then** イベントが購入者向け画面に表示される

---

### User Story 2 - 購入者によるイベント検索・チケット購入（座席指定） (Priority: P1)

購入者がイベントを検索し、座席を選択してチケットを購入できる（会員登録済み前提）。

**Why this priority**: システムの中核機能。購入フローが完成すれば、MVPとして価値を提供できる。

**Independent Test**: 購入者がトップページからイベント検索 → イベント詳細確認 → 座席選択画面で空席を選択 → カートに追加 → 購入者情報確認 → 決済（プロトタイプでは簡易実装） → 購入完了。この一連の流れが独立して動作し、チケット購入の価値を提供。

**Acceptance Scenarios**:

1. **Given** 公開イベントが登録済み, **When** 購入者がトップページでイベント検索（日付、カテゴリ、エリア）, **Then** 条件に合致するイベント一覧が表示される
2. **Given** イベント一覧が表示されている, **When** イベントを選択, **Then** イベント詳細（名称、説明、開催日時、会場、チケット種別、価格）が表示される
3. **Given** イベント詳細が表示されている, **When** 「座席を選択」ボタンをクリック, **Then** ビジュアル座席表が表示され、空席/予約済/売約済が色分けされる
4. **Given** 座席選択画面が表示されている, **When** 空席を選択（複数可）, **Then** 選択した座席がハイライトされ、「カートに追加」ボタンが有効化される
5. **Given** 座席を選択済み, **When** 「カートに追加」ボタンをクリック, **Then** カートページに遷移し、選択チケット一覧と合計金額が表示される
6. **Given** カートに商品がある, **When** 「購入手続きへ」ボタンをクリック, **Then** 購入者情報確認画面（氏名、メール、電話番号）が表示される
7. **Given** 購入者情報を確認済み, **When** 「決済へ進む」ボタンをクリック, **Then** 決済画面（プロトタイプでは簡易実装：購入確定ボタン）が表示される
8. **Given** 決済画面が表示されている, **When** 「購入確定」ボタンをクリック, **Then** 注文が確定し、購入完了画面（注文番号、チケット確認リンク）が表示される
9. **Given** 購入完了, **When** 購入完了画面を確認, **Then** 座席ステータスが「売約済」に変更され、他の購入者は選択できない

---

### User Story 3 - 電子チケット発行とメール送信 (Priority: P1)

購入者がチケット購入後、QRコード付き電子チケットが発行され、メールで受信できる。

**Why this priority**: 購入後の体験を完結させる機能。これがないとチケットを受け取れない。

**Independent Test**: 購入者がチケット購入完了 → システムがQRコード付き電子チケットPDFを生成 → メール（コンソール出力）で送信 → マイページでチケット表示・ダウンロード可能。この流れで電子チケットシステムとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** チケット購入が完了, **When** 注文が確定される, **Then** QRコード付き電子チケット（PDF）が自動生成される
2. **Given** 電子チケットが生成済み, **When** システムがメール送信処理を実行, **Then** 購入者のメールアドレス宛にチケット添付メールが送信される（プロトタイプではコンソール出力）
3. **Given** 購入者がログイン済み, **When** マイページにアクセス, **Then** 購入履歴とチケット一覧が表示される
4. **Given** マイページにチケットが表示されている, **When** チケットを選択, **Then** チケット詳細（QRコード、イベント情報、座席情報）が表示される
5. **Given** チケット詳細が表示されている, **When** 「ダウンロード」ボタンをクリック, **Then** QRコード付きチケットPDFがダウンロードされる

---

### User Story 4 - 入場管理（QRコードスキャン） (Priority: P1)

イベント当日、スタッフがQRコードをスキャンして入場記録を管理できる。

**Why this priority**: チケット販売システムの完結。入場管理がないと不正入場や重複入場を防げない。

**Independent Test**: スタッフが入場管理アプリ（またはWebページ）でQRコードスキャン → チケット有効性確認 → 入場記録保存 → 重複入場チェック。この機能で入場管理システムとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** スタッフが入場管理画面にアクセス済み, **When** QRコードをスキャン（カメラまたは手動入力）, **Then** チケット情報（購入者名、イベント名、座席番号）が表示される
2. **Given** チケット情報が表示されている, **When** チケットが有効（未使用）, **Then** 「入場許可」メッセージが表示され、入場記録が保存される
3. **Given** チケット情報が表示されている, **When** チケットが無効（既に使用済み）, **Then** 「入場拒否」メッセージと使用日時が表示される
4. **Given** チケット情報が表示されている, **When** チケットが存在しない（偽造または無効なQRコード）, **Then** 「無効なチケット」エラーメッセージが表示される
5. **Given** 主催者が管理画面にアクセス済み, **When** 入場管理画面を表示, **Then** リアルタイム入場人数、入場者リスト、ゲート別入場状況が表示される

---

### User Story 5 - 会員登録・認証・マイページ (Priority: P1)

購入者がメールアドレスで会員登録し、ログインしてマイページで購入履歴とチケットを確認できる。

**Why this priority**: 購入者の認証基盤。会員管理がないと購入履歴の管理やリピート購入ができない。

**Independent Test**: 購入者が新規会員登録（メール、パスワード、基本情報） → ログイン → マイページで購入履歴・チケット確認 → 会員情報編集 → パスワードリセット。この流れで会員管理システムとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** 未登録の購入者, **When** 会員登録画面でメールアドレス、パスワード、氏名、電話番号を入力, **Then** 会員登録が完了し、ログイン状態になる
2. **Given** 登録済み会員, **When** ログイン画面でメールアドレスとパスワードを入力, **Then** ログインが成功し、トップページに遷移する
3. **Given** ログイン済み会員, **When** マイページにアクセス, **Then** 基本情報（氏名、メール、電話番号）、購入履歴、チケット一覧が表示される
4. **Given** マイページが表示されている, **When** 会員情報編集画面で氏名や電話番号を変更, **Then** 変更が保存され、マイページに反映される
5. **Given** ログイン画面, **When** 「パスワードを忘れた方」リンクをクリック, **Then** パスワードリセット画面が表示され、メールアドレスを入力すると、リセットリンクがメール送信される（コンソール出力）
6. **Given** ログイン試行, **When** 5回連続でパスワードを間違える, **Then** アカウントが一時ロックされ、「しばらくしてから再試行してください」メッセージが表示される（Brute force攻撃対策）

---

### User Story 6 - 主催者ダッシュボードと売上管理 (Priority: P2)

主催者が管理画面で売上サマリー、販売状況、入場状況をリアルタイムで確認できる。

**Why this priority**: 主催者の運用を支援する重要機能だが、MVPの動作には必須ではない。

**Independent Test**: 主催者が管理画面にログイン → ダッシュボードで売上サマリー（合計売上、販売枚数）、イベント別売上、販売推移グラフ、入場状況を確認 → CSV出力。この機能で主催者向け管理システムとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** 主催者が管理画面にログイン済み, **When** ダッシュボードにアクセス, **Then** 売上サマリー（合計売上、販売枚数、完売イベント数）が表示される
2. **Given** ダッシュボードが表示されている, **When** イベント別売上タブを選択, **Then** イベントごとの売上、販売枚数、残枚数が一覧表示される
3. **Given** ダッシュボードが表示されている, **When** 販売推移タブを選択, **Then** 日次・週次・月次の販売推移グラフが表示される
4. **Given** ダッシュボードが表示されている, **When** 入場状況タブを選択, **Then** リアルタイム入場人数、入場者リスト、ゲート別入場状況が表示される
5. **Given** 売上データが表示されている, **When** 「CSV出力」ボタンをクリック, **Then** 売上データCSVファイルがダウンロードされる

---

### User Story 7 - 購入者によるイベント検索・チケット購入（自由席） (Priority: P2)

購入者が自由席チケットを購入できる（座席選択なし、枚数のみ指定）。

**Why this priority**: 座席指定の次に重要な購入パターン。座席選択UIが不要なため、実装は比較的簡単。

**Independent Test**: 購入者がイベント検索 → 自由席イベント詳細確認 → 枚数を指定してカートに追加 → 購入手続き → 購入完了。座席指定なしの購入フローとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** 自由席イベントが公開済み, **When** イベント詳細画面を表示, **Then** チケット種別「自由席」と価格、残枚数が表示される
2. **Given** イベント詳細が表示されている, **When** 枚数選択（1〜10枚）して「カートに追加」ボタンをクリック, **Then** カートページに遷移し、選択枚数と合計金額が表示される
3. **Given** カートに自由席チケットがある, **When** 購入手続きを完了, **Then** 注文が確定し、自由席チケット（QRコード付き、座席番号なし）が発行される
4. **Given** 自由席チケット購入完了, **When** マイページでチケット確認, **Then** チケット詳細に「自由席」と表示され、座席番号は表示されない

---

### User Story 8 - キャンセル・返金処理 (Priority: P3)

購入者がチケットをキャンセルし、座席が再販売可能になる。

**Why this priority**: ユーザー体験を向上させるが、MVPには必須ではない。将来的に重要。

**Independent Test**: 購入者がマイページからキャンセル申請 → 主催者が承認（またはシステムが自動承認） → 座席ステータスが「空席」に戻る → 返金処理（プロトタイプでは記録のみ）。この機能でキャンセル管理システムとして独立した価値を提供。

**Acceptance Scenarios**:

1. **Given** 購入者がマイページでチケット確認中, **When** 「キャンセル申請」ボタンをクリック, **Then** キャンセル確認画面が表示される
2. **Given** キャンセル確認画面が表示されている, **When** キャンセル理由を入力して「申請」ボタンをクリック, **Then** キャンセル申請が保存され、ステータスが「キャンセル申請中」になる
3. **Given** 主催者が管理画面でキャンセル申請一覧を確認中, **When** キャンセル申請を承認, **Then** 注文ステータスが「キャンセル済」に変更され、座席ステータスが「空席」に戻る
4. **Given** キャンセルが承認済み, **When** システムが返金処理を実行, **Then** 返金記録が保存され、購入者にキャンセル完了メール（コンソール出力）が送信される
5. **Given** キャンセルが承認済み, **When** 購入者がマイページを確認, **Then** チケットステータスが「キャンセル済」と表示される

---

### Edge Cases

- **座席の同時選択**: 複数の購入者が同じ座席を同時に選択した場合、最初に購入確定した購入者のみが購入でき、他の購入者にはエラーメッセージ「この座席は既に購入されました」が表示される（楽観的ロックまたはトランザクション制御）
- **カートタイムアウト**: カートに追加してから10分間放置された場合、座席の仮予約が解除され、他の購入者が購入可能になる
- **決済エラー**: 決済処理中にエラーが発生した場合、注文ステータスが「決済失敗」になり、座席が再度空席に戻る
- **QRコード重複スキャン**: 同じQRコードが複数回スキャンされた場合、2回目以降は「既に入場済み」エラーが表示される
- **イベント中止**: 主催者がイベントを中止した場合、全購入者に中止通知メール（コンソール出力）が送信され、自動返金処理が実行される
- **無効なQRコード**: 偽造または無効なQRコードがスキャンされた場合、「無効なチケット」エラーメッセージが表示され、スタッフに警告が表示される
- **販売枚数上限**: チケット種別の販売枚数が上限に達した場合、「売り切れ」と表示され、カートに追加できない
- **過去イベントの購入**: 開催日時が過去のイベントは、イベント一覧に表示されるが「販売終了」と表示され、購入できない
- **会員情報の重複**: 同じメールアドレスで複数回会員登録しようとした場合、「このメールアドレスは既に登録されています」エラーが表示される
- **外部利用者間の情報参照**: 購入者Aが購入者Bの購入履歴やチケットを閲覧できないよう、認証とアクセス制御を実装する

## Requirements *(mandatory)*

### Functional Requirements

#### イベント管理
- **FR-001**: 主催者は会場を登録できる（名称、住所、収容人数）
- **FR-002**: 主催者は座席表を作成できる（ブロック、列、番号、座席種別）
- **FR-003**: 主催者はイベントを登録できる（名称、説明、カテゴリ、開催日時、会場、主催者情報）
- **FR-004**: 主催者はチケット種別を設定できる（座席指定/自由席、価格、販売枚数）
- **FR-005**: 主催者はイベントを公開/非公開設定できる
- **FR-006**: 主催者はイベントを編集・削除できる

#### チケット購入
- **FR-007**: 購入者はイベントを検索できる（日付、カテゴリ、エリア）
- **FR-008**: 購入者はイベント詳細を閲覧できる（名称、説明、開催日時、会場、チケット種別、価格）
- **FR-009**: 購入者は座席選択画面でビジュアル座席表を確認できる（空席/予約済/売約済の色分け）
- **FR-010**: 購入者は空席を選択してカートに追加できる（複数選択可）
- **FR-011**: 購入者はカートで選択チケット一覧と合計金額を確認できる
- **FR-012**: 購入者は購入者情報（氏名、メール、電話番号）を入力できる
- **FR-013**: 購入者は決済を完了できる（プロトタイプでは簡易実装）
- **FR-014**: システムは注文確定時に注文番号を発行する
- **FR-015**: システムは購入完了後、座席ステータスを「売約済」に変更する

#### 電子チケット
- **FR-016**: システムは注文確定時にQRコード付き電子チケットPDFを生成する
- **FR-017**: システムは購入者宛にチケット添付メールを送信する（プロトタイプではコンソール出力）
- **FR-018**: 購入者はマイページで購入履歴とチケット一覧を確認できる
- **FR-019**: 購入者はマイページでチケット詳細（QRコード、イベント情報、座席情報）を表示できる
- **FR-020**: 購入者はチケットPDFをダウンロードできる

#### 入場管理
- **FR-021**: スタッフは入場管理画面でQRコードをスキャンできる（カメラまたは手動入力）
- **FR-022**: システムはQRコードから チケット情報（購入者名、イベント名、座席番号）を表示する
- **FR-023**: システムはチケット有効性を検証する（未使用/使用済み/無効）
- **FR-024**: システムは有効なチケットの入場記録を保存する（入場日時、ゲート）
- **FR-025**: システムは重複入場を検出し、エラーメッセージを表示する
- **FR-026**: 主催者は入場管理画面でリアルタイム入場人数、入場者リスト、ゲート別入場状況を確認できる

#### 会員管理
- **FR-027**: 購入者は会員登録できる（メールアドレス、パスワード、氏名、電話番号）
- **FR-028**: システムはメールアドレスの重複登録を防止する
- **FR-029**: 購入者はメールアドレスとパスワードでログインできる
- **FR-030**: 購入者はマイページで会員情報を編集できる
- **FR-031**: 購入者はパスワードをリセットできる（メールでリセットリンク送信、コンソール出力）
- **FR-032**: システムはログイン失敗5回でアカウントを一時ロックする（Brute force攻撃対策）

#### 主催者管理
- **FR-033**: 主催者は管理画面にログインできる（認証）
- **FR-034**: 主催者はダッシュボードで売上サマリー（合計売上、販売枚数、完売イベント数）を確認できる
- **FR-035**: 主催者はイベント別売上を確認できる（売上、販売枚数、残枚数）
- **FR-036**: 主催者は販売推移グラフを確認できる（日次・週次・月次）
- **FR-037**: 主催者は売上データをCSV出力できる

#### キャンセル管理（P3）
- **FR-038**: 購入者はマイページからキャンセル申請できる
- **FR-039**: 主催者はキャンセル申請を承認/却下できる
- **FR-040**: システムはキャンセル承認時に座席ステータスを「空席」に戻す
- **FR-041**: システムはキャンセル承認時に返金記録を保存する
- **FR-042**: システムはキャンセル完了メールを送信する（コンソール出力）

#### データ整合性とセキュリティ
- **FR-043**: システムは座席の二重販売を防止する（トランザクション制御または楽観的ロック）
- **FR-044**: システムはカート追加から10分間で座席仮予約を解除する
- **FR-045**: システムはCSRF攻撃を防止する（Djangoトークン）
- **FR-046**: システムはSQLインジェクション攻撃を防止する（Django ORM使用）
- **FR-047**: システムはXSS攻撃を防止する（テンプレート自動エスケープ）
- **FR-048**: システムはすべての操作ログを記録する
- **FR-049**: システムは購入者間で互いの情報を参照できないよう制御する

### Key Entities

- **Venue（会場）**: 会場名、住所、収容人数。座席表の親エンティティ。
- **Seat（座席）**: 会場に紐づく座席。ブロック、列、番号、座席種別（S/A/B）、ステータス（空席/予約中/売約済）。
- **Event（イベント）**: イベント名、説明、カテゴリ、開催日時、会場（FK to Venue）、主催者、公開/非公開ステータス。
- **TicketType（チケット種別）**: イベントに紐づく。種別名（座席指定/自由席）、価格、販売枚数、販売期間。
- **Member/User（会員）**: メールアドレス、パスワード（ハッシュ化）、氏名、電話番号、登録日時。
- **Order（注文）**: 購入者（FK to User）、注文番号、注文日時、合計金額、決済ステータス。
- **Ticket（チケット）**: 注文（FK to Order）に紐づく。チケット番号、QRコード、座席（FK to Seat、自由席の場合はNULL）、ステータス（有効/使用済/キャンセル済）。
- **Payment（決済）**: 注文（FK to Order）に紐づく。決済方法、決済金額、決済日時、決済ステータス（プロトタイプでは簡易実装）。
- **Entry（入場記録）**: チケット（FK to Ticket）に紐づく。入場日時、ゲート、スキャンスタッフ。
- **Organizer（主催者）**: 主催者名、アカウント情報、権限（管理者/スタッフ）。
- **Cancellation（キャンセル）**: 注文（FK to Order）に紐づく。キャンセル日時、理由、ステータス（申請中/承認済/却下）、返金額。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 購入者は3クリック以内でチケット購入を完了できる（イベント選択 → 座席選択 → 購入確定）
- **SC-002**: システムは座席の二重販売を0件に維持する（トランザクション制御により）
- **SC-003**: 主催者はイベント登録から公開まで10分以内に完了できる
- **SC-004**: 購入者はチケット購入完了から5分以内に電子チケットを受信できる（メール送信処理）
- **SC-005**: 入場管理スタッフはQRコードスキャンから入場許可判定まで3秒以内に完了できる
- **SC-006**: システムはログイン失敗5回でアカウントを一時ロックし、Brute force攻撃を防止する
- **SC-007**: 主催者は管理画面で売上データをリアルタイムで確認でき、CSVエクスポートまで1分以内に完了できる
- **SC-008**: 購入者はマイページで過去のチケット購入履歴を全件確認できる
- **SC-009**: システムは画面表示を3秒以内、決済処理を5秒以内に完了する（パフォーマンス要件）
- **SC-010**: 購入者と主催者は互いの個人情報を参照できない（アクセス制御により）
