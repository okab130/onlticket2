{% extends 'base.html' %}

{% block title %}{{ event.name }} - TicketPro{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'events:public_event_list' %}">イベント一覧</a></li>
            <li class="breadcrumb-item active">{{ event.name }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- イベント画像・詳細 -->
        <div class="col-md-8">
            <div class="card mb-4">
                {% if event.image %}
                <img src="{{ event.image.url }}" class="card-img-top" alt="{{ event.name }}" style="max-height: 400px; object-fit: cover;">
                {% endif %}
                
                <div class="card-body">
                    <h2 class="card-title">{{ event.name }}</h2>
                    <p class="text-muted">
                        <span class="badge bg-info text-dark">{{ event.get_category_display }}</span>
                    </p>
                    
                    <hr>
                    
                    <h5><i class="bi bi-info-circle"></i> イベント詳細</h5>
                    <p style="white-space: pre-wrap;">{{ event.description }}</p>
                    
                    <hr>
                    
                    <h5><i class="bi bi-calendar-event"></i> 開催日時</h5>
                    <p>{{ event.start_datetime|date:"Y年m月d日 (D) H:i" }} ～ {{ event.end_datetime|date:"H:i" }}</p>
                    
                    <h5><i class="bi bi-geo-alt"></i> 会場</h5>
                    <p>
                        <strong>{{ event.venue.name }}</strong><br>
                        {{ event.venue.address }}<br>
                        収容人数: {{ event.venue.capacity }}名
                    </p>
                    
                    {% if event.venue.seat_map_image %}
                    <h5><i class="bi bi-map"></i> 座席表</h5>
                    <img src="{{ event.venue.seat_map_image.url }}" class="img-fluid" alt="座席表">
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- チケット購入 -->
        <div class="col-md-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-ticket-perforated"></i> チケット購入</h5>
                </div>
                <div class="card-body">
                    {% if ticket_types %}
                    {% for ticket_type in ticket_types %}
                    <div class="mb-3 p-3 border rounded">
                        <h6>{{ ticket_type.name }}</h6>
                        <p class="mb-1"><strong class="text-primary fs-4">¥{{ ticket_type.price|floatformat:0 }}</strong></p>
                        <p class="text-muted small mb-2">
                            残り: {{ ticket_type.remaining_quantity }}枚 / {{ ticket_type.total_quantity }}枚
                        </p>
                        <p class="text-muted small mb-2">
                            販売期間: {{ ticket_type.sale_start|date:"m/d H:i" }} ～ {{ ticket_type.sale_end|date:"m/d H:i" }}
                        </p>
                        {% if ticket_type.remaining_quantity > 0 %}
                            {% if ticket_type.type == 'reserved' %}
                                <a href="{% url 'seats:seat_selection' event.pk ticket_type.pk %}" class="btn btn-primary w-100">座席を選ぶ</a>
                            {% elif ticket_type.type == 'free' %}
                                <form method="post" action="{% url 'orders:add_to_cart_free' %}" class="free-seating-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="ticket_type_id" value="{{ ticket_type.pk }}">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">枚数</span>
                                        <input type="number" name="quantity" class="form-control" min="1" max="{{ ticket_type.remaining_quantity }}" value="1" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">カートに追加</button>
                                </form>
                            {% endif %}
                        {% else %}
                        <button class="btn btn-secondary w-100" disabled>売り切れ</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-warning">
                        現在販売中のチケットはありません。
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
